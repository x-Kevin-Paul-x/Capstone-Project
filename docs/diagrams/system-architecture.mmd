flowchart TB
    %% Styling
    classDef pqcLayer fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    classDef secureLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef infraLayer fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef dataFlow stroke:#d32f2f,stroke-width:2px
    classDef keyFlow stroke:#ff6f00,stroke-width:2px,stroke-dasharray: 5 5

    %% Stakeholders & External Interfaces
    subgraph EXT[" ğŸ§‘â€ğŸ’» External Stakeholders & Interfaces"]
        HUMAN[Human Operator]
        DEVOPS[DevOps Engineer]
        ADMIN[Security Administrator]
    end

    %% Cloud Infrastructure & Services
    subgraph CLOUD[" â˜ï¸ Cloud Infrastructure & Backend Services"]
        direction TB
        
        subgraph CICD[" ğŸ”„ CI/CD Pipeline"]
            BUILD[Build Service]
            SIGN[PQC Firmware Signer<br/>ğŸ” Dilithium Signing]
            TEST[Automated Testing]
        end
        
        subgraph STORAGE[" ğŸ“¦ Artifact & Key Storage"]
            REPO[(Signed Firmware Repository<br/>ğŸ“ .bin + .sig + metadata)]
            KEYSTORE[(Certificate Store<br/>ğŸ—ï¸ Public Keys & Certificates)]
        end
        
        subgraph SERVICES[" ğŸ› ï¸ Backend Services"]
            API[Robot Control API]
            KMS[Key Management Service<br/>ğŸ”‘ Provisioning, Rotation, Revocation]
            ANALYTICS[Analytics Engine<br/>ğŸ“Š Future: FHE Privacy Analytics]
        end
        
        subgraph MONITOR[" ğŸ“ˆ Monitoring & Observability"]
            LOGS[(Log Aggregation)]
            METRICS[(Metrics & Telemetry)]
            ALERTS[Security Alerts]
        end
    end

    %% Secure Network Communication Layer
    subgraph NETWORK[" ğŸŒ Secure Communication Layer"]
        direction LR
        TLS[Hybrid TLS 1.3 Session<br/>ğŸ”’ Classical ECDH + PQC Kyber KEM<br/>ğŸ“¡ Forward & Post-Quantum Secure]
        
        subgraph PROTOCOLS[" ğŸ“‹ Protocol Stack"]
            APP_PROTO[Application Protocols<br/>HTTP/2, gRPC, WebSocket]
            MSG_SIGN[Message-Level Signing<br/>ğŸ–Šï¸ Dilithium Signatures]
            TRANSPORT[Transport Security<br/>TLS 1.3 + PQC Extensions]
        end
    end

    %% Robot Device Architecture
    subgraph ROBOT[" ğŸ¤– Robot Device Architecture"]
        direction TB
        
        subgraph HARDWARE[" âš™ï¸ Hardware Security Layer"]
            TPM[TPM 2.0 / Secure Element<br/>ğŸ”’ Root of Trust<br/>ğŸ—ï¸ Private Key Storage]
            MCU[MCU/SoC<br/>ARM Cortex / x86<br/>Crypto Accelerators]
            SENSORS[Sensors & Actuators<br/>ğŸ¯ Vision, Lidar, Motors<br/>ğŸ“¡ Industrial I/O]
        end
        
        subgraph BOOT[" ğŸš€ Secure Boot Chain"]
            ROM[Boot ROM<br/>ğŸ” Hardware Root of Trust]
            BOOTLOADER[Secure Bootloader<br/>âœ… PQC Signature Verification<br/>ğŸ”„ Recovery & Rollback<br/>ğŸ“œ Dilithium Verify]
            FIRMWARE[Application Firmware<br/>ğŸ¯ Robot Control Logic<br/>ğŸ“Š Telemetry Collection]
        end
        
        subgraph RUNTIME[" ğŸ’» Runtime Environment"]
            OS[RTOS/Linux Kernel<br/>âš¡ Real-time Scheduling<br/>ğŸ”§ Device Drivers]
            MIDDLEWARE[Middleware Layer<br/>ğŸ¤ ROS2/DDS Integration<br/>ğŸ–Šï¸ Message Authentication<br/>ğŸ“¨ Dilithium Message Signing]
            NETWORKING[Network Stack<br/>ğŸŒ TCP/IP, UDP<br/>ğŸ”’ TLS/DTLS + liboqs<br/>ğŸ“¡ Wireless Interfaces]
        end
    end

    %% Development & Testing Infrastructure
    subgraph TESTING[" ğŸ§ª Development & Testing Infrastructure"]
        HIL[Hardware-in-Loop Testbench<br/>âš¡ Automated Flash & Boot<br/>ğŸ” Security Validation<br/>ğŸ“Š Performance Monitoring]
        SIM[Robot Simulator<br/>ğŸ® Virtual Environment<br/>ğŸ§ª Protocol Testing]
        TOOLS[Development Tools<br/>ğŸ”§ Firmware Signing CLI<br/>ğŸ“‹ Key Management Tools]
    end

    %% Data and Control Flows
    
    %% External User Interactions
    HUMAN -->|Monitor & Control| API
    DEVOPS -->|Deploy & Configure| CICD
    ADMIN -->|Manage Keys & Policies| KMS
    
    %% CI/CD Pipeline Flow
    BUILD -->|Build Firmware| SIGN
    SIGN -->|Sign with Dilithium| REPO
    TEST -->|Validate Signatures| HIL
    
    %% Key Management Flow
    KMS -.->|Provision Public Keys| TPM
    KMS -.->|Certificate Distribution| KEYSTORE
    KMS -.->|Key Rotation Events| BOOTLOADER
    
    %% Firmware Delivery & Boot Process
    REPO -->|OTA/USB Update| BOOTLOADER
    TPM -.->|Public Key Bundle| BOOTLOADER
    ROM --> BOOTLOADER
    BOOTLOADER -->|âœ… Signature Valid| FIRMWARE
    BOOTLOADER -->|âŒ Signature Invalid| BOOTLOADER
    
    %% Runtime Communication Flow
    FIRMWARE --> OS
    OS --> SENSORS
    FIRMWARE --> MIDDLEWARE
    MIDDLEWARE --> NETWORKING
    NETWORKING <-->|Hybrid TLS + Message Signing| TLS
    TLS <--> API
    
    %% Monitoring & Observability
    FIRMWARE -.->|Telemetry & Logs| LOGS
    BOOTLOADER -.->|Boot Events & Errors| LOGS
    MIDDLEWARE -.->|Message Audit Trail| LOGS
    SIGN -.->|Signing Events| LOGS
    LOGS --> METRICS
    METRICS --> ALERTS
    
    %% Testing & Validation
    HIL -.->|Flash & Reboot| BOOTLOADER
    HIL -.->|Functional Tests| FIRMWARE
    SIM -.->|Protocol Testing| NETWORKING
    TOOLS -.->|CLI Operations| SIGN

    %% Apply styling
    class TPM,BOOTLOADER,SIGN,MSG_SIGN,TLS pqcLayer
    class ROM,FIRMWARE,OS,API,KMS secureLayer
    class BUILD,REPO,LOGS,METRICS,HIL infraLayer